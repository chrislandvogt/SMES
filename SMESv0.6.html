<!DOCTYPE html>
<html>
<head>
    <title>SMES DEMO (JSAPI)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
        /* width & color of legend */
        div.esri-component.esri-legend.esri-widget.esri-widget--panel {
            max-width: 175px;
            background-color: rgba(255,255,255,0.8);
        }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.30/"></script>
    <script>
        function base64ToBlob(base64, type = "application/pdf") {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return new Blob([bytes], { type });
        }

        require([
            "esri/config",
            "esri/WebMap",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/core/reactiveUtils",
            "esri/widgets/Search",
            "esri/widgets/Locate",
            "esri/widgets/LayerList",
            "esri/widgets/Legend",
            "esri/layers/support/FeatureFilter",
            "esri/form/elements/inputs/SwitchInput",
        ], function (esriConfig, WebMap, MapView, FeatureLayer, reactiveUtils, Search, Locate, LayerList, Legend, FeatureFilter, SwitchInput) {  
            const SimpleRenderer = {
                type: "simple",
                symbol: {
                    type: "simple-line",
                    color: "rgba(0,76,115,0)",
                    width: "2px",
                }
            };

            const uniqueValueRenderer = {
                type: "unique-value",
                field: "symbol",
                uniqueValueInfos: [
                    {
                        value: "NA",
                        label: "Non-SCN (GDA)",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/nonSCNnoht.png",
                        }
                    },
                    {
                        value: "SP",
                        label: "PCM",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/PCM.png",
                        }
                    },
                    {
                        value: "SC",
                        label: "Non-SCN (GDA) & AHD mark",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/nonSCNAHD.png",
                        }
                    },
                    {
                        value: "NS",
                        label: "Non-SCN (GDA) & Estimated AHD",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/NonSCNESTAHD.png",
                        }
                    },
                    {
                        value: "ASC",
                        label: "Non-SCN (GDA) & Adjusted AHD mark",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/nonSCNAdjusted.png",
                        }
                    },
                    {
                        value: "SST",
                        label: "SCN (GDA) & Estimated AHD",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/SCNESTAHD.png",
                        }
                    },
                    {
                        value: "ASCT",
                        label: "SCN (GDA) & Adjusted AHD mark ",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/SCNADH.png",
                        }
                    },
                    {
                        value: "SCT",
                        label: "Non-SCN (GDA)",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/nonSCNnoht.png",
                        }
                    },
                    {
                        value: "ST",
                        label: "Non-SCN (GDA)",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/nonSCNnoht.png",
                        }
                    },
                    {
                        value: "D",
                        label: "Defective",
                        symbol: {
                            type: "picture-marker",
                            url: "https://clstoragea.blob.core.windows.net/chris/defective.png",
                        }
                    },
                ]
            };

            const labelsmes = {
                symbol: {
                    type: "text",
                    color: "#000000",
                    font: {
                        size: "11px",
                        family: "Noto Sans",
                        style: "normal",
                        weight: "normal"
                    }
                },
                labelPlacement: "above-center",
                labelExpressionInfo: {
                    expression: "$feature.name"
                }
            };

            const labelprop = {
                symbol: {
                    type: "text",
                    color: "#5E8D74",
                    font: {
                        size: "8px",
                        family: "Noto Sans",
                        style: "normal",
                        weight: "normal"
                    }
                },
                labelPlacement: "always-horizontal",
                labelExpressionInfo: {
                    expression: "$feature.parcel_spi"
                }
            };

            const downloadPdfAction = {
                title: "Download Sketch PDF",
                id: "download-pdf",
                className: "esri-icon-download"
            };

            const navigateAction = {
                title: "Navigate To",
                id: "navigate-to",
                className: "esri-icon-directions" // This assumes there's a 'directions' icon in Esri's icon set. Adjust as needed.
            };

            const popupTemplate = {
                "title": "PM Details",
                "content": [{
                    type: "fields",
                    fieldInfos: [
                        {
                            fieldName: "name",
                            label: "Name"
                        },
                        {
                            fieldName: "mga2020_easting",
                            label: "MGA 2020 Easting",
                            format: {
                                places: 3
                            }
                        },
                        {
                            fieldName: "mga2020_northing",
                            label: "MGA 2020 Northing",
                            format: {
                                places: 3
                            }
                        },
                        {
                            fieldName: "ahd_height",
                            label: "AHD Height",
                            format: {
                                places: 3
                            }
                        },
                        {
                            fieldName: "GDA94_UNCERTAINTY",
                            label: "Horizontal uncertainty",
                            format: {
                                places: 3
                            }
                        },
                        {
                            fieldName: "V_UNCERTAINTY",
                            label: "Vertical uncertainty",
                            format: {
                                places: 3
                            }
                        },
                    ]
                }],
                "actions": [downloadPdfAction, navigateAction]
            };

            const SMES = new FeatureLayer({
                url: "https://services6.arcgis.com/GB33F62SbDxJjwEL/arcgis/rest/services/Vicmap_Position/FeatureServer/0",
                outFields: ["name", "ahd_height", "mga2020_easting", "mga2020_northing", "nine_figure_no", "symbol", "GDA94_UNCERTAINTY", "V_UNCERTAINTY", "ahd_height", "GDA94_LATITUDE_DMS" ,"GDA94_LONGITUDE_DMS"],
                popupTemplate: popupTemplate,
                minScale: 50000,
                renderer: uniqueValueRenderer,
                labelingInfo: [labelsmes]
            });

            const parcel = new FeatureLayer({
                url: "https://services6.arcgis.com/GB33F62SbDxJjwEL/ArcGIS/rest/services/Vicmap_Parcel/FeatureServer/0",
                minScale: 5000,
                renderer: SimpleRenderer,
                labelingInfo: [labelprop]
            });

            const webmap = new WebMap({
                basemap: "topo-vector"
            });

            webmap.add(SMES);
            webmap.add(parcel);

            const view = new MapView({
                container: "viewDiv",
                map: webmap,
                center: [144.95608778666826,-37.79451232606005], // Longitude, Latitude for Parkville
                zoom: 18
            });

            view.ui.move("zoom", "top-right");

            // Dynamic Legend with extent filtering
            const legend = new Legend({
                view: view,
                layerInfos: [{
                    layer: SMES,
                    title: "Survey Marks"
                }]
            });
            view.ui.add(legend, "bottom-left");

            reactiveUtils.watch(
                () => view.extent,
                () => {
                    view.whenLayerView(SMES).then((layerView) => {
                        layerView.filter = new FeatureFilter({
                            geometry: view.extent
                        });
                        console.log("Layer filtered to current extent.");
                    });
                }
            );

            // Add switches for filtering
            const switchContainer = document.createElement("div");
            switchContainer.style.position = "absolute";
            switchContainer.style.bottom = "60px";
            switchContainer.style.right = "25px";
            switchContainer.style.background = "rgba(255,255,255,0.7)";
            switchContainer.style.padding = "10px";
            document.body.appendChild(switchContainer);

            const switches = [
                { label: "AHD levelling only", id: "toggleLayer1", filter: "V_ORDER >= 1 AND V_ORDER <= 3 AND status = 'OK'" },
                { label: "Coordinated MGA/SCN only", id: "toggleLayer2", filter: "scn_gda = 'YES' AND status = 'OK'" },
                { label: "Hide defective marks", id: "toggleLayer3", filter: "symbol <> 'D'", checked: true }
            ];

            switches.forEach(s => {
                const switchDiv = document.createElement("div");
                const switchLabel = document.createElement("label");
                switchLabel.innerHTML = s.label;
                const switchInput = document.createElement("input");
                switchInput.type = "checkbox";
                switchInput.id = s.id;
                if (s.checked) switchInput.checked = true;

                switchDiv.appendChild(switchInput);
                switchDiv.appendChild(switchLabel);
                switchContainer.appendChild(switchDiv);

                view.whenLayerView(SMES).then(layerView => {
                    if (s.checked) {
                        layerView.filter = new FeatureFilter({
                            where: s.filter
                        });
                    }

                    switchInput.addEventListener("change", () => {
                        if (switchInput.checked) {
                            layerView.filter = new FeatureFilter({
                                where: s.filter
                            });
                        } else {
                            layerView.filter = null;
                        }
                    });
                });
            });
        });
    </script>
</head>
<body>
    <div id="viewDiv"></div>
</body>
</html>
