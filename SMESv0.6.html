<!DOCTYPE html>
<html>
<head>
    <title>SMES DEMO (JSAPI)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
        /* Style the legend */
        div.esri-component.esri-legend.esri-widget.esri-widget--panel {
            max-width: 175px;
            background-color: rgba(255,255,255,0.8);
        }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.30/"></script>
</head>
<body>
    <div id="viewDiv"></div>
    <script>
        require([
            "esri/WebMap",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/widgets/Track",
            "esri/widgets/Legend",
            "esri/widgets/Search",
            "esri/core/reactiveUtils",
            "esri/layers/support/FeatureFilter"
        ], function(WebMap, MapView, FeatureLayer, Track, Legend, Search, reactiveUtils, FeatureFilter) {

            // Unique Value Renderer
            const uniqueValueRenderer = {
                type: "unique-value",
                field: "symbol",
                uniqueValueInfos: [
                    { value: "NA", label: "Non-SCN (GDA)", symbol: { type: "picture-marker", url: "https://clstoragea.blob.core.windows.net/chris/nonSCNnoht.png" } },
                    { value: "SP", label: "PCM", symbol: { type: "picture-marker", url: "https://clstoragea.blob.core.windows.net/chris/PCM.png" } },
                    { value: "SC", label: "Non-SCN (GDA) & AHD mark", symbol: { type: "picture-marker", url: "https://clstoragea.blob.core.windows.net/chris/nonSCNAHD.png" } },
                    { value: "D", label: "Defective", symbol: { type: "picture-marker", url: "https://clstoragea.blob.core.windows.net/chris/defective.png" } }
                ]
            };

            // Feature Layer
            const SMES = new FeatureLayer({
                url: "https://services6.arcgis.com/GB33F62SbDxJjwEL/arcgis/rest/services/Vicmap_Position/FeatureServer/0",
                renderer: uniqueValueRenderer,
                outFields: ["name", "symbol"],
                popupTemplate: {
                    title: "PM Details",
                    content: "<b>Name:</b> {name}<br/><b>Symbol:</b> {symbol}"
                }
            });

            // WebMap and MapView
            const webmap = new WebMap({
                basemap: "topo-vector",
                layers: [SMES]
            });

            const view = new MapView({
                container: "viewDiv",
                map: webmap,
                center: [144.95608778666826, -37.79451232606005],
                zoom: 18
            });

            // Track Widget
            const trackWidget = new Track({
                view: view,
                goToLocationEnabled: true
            });
            view.ui.add(trackWidget, "top-right");

            // Legend Widget
            const legend = new Legend({
                view: view,
                layerInfos: [{ layer: SMES, title: "Survey Marks" }]
            });
            view.ui.add(legend, "bottom-left");

            // Search Widget
            const searchWidget = new Search({
                view: view,
                allPlaceholder: "Search survey marks",
                sources: [
                    {
                        layer: SMES,
                        searchFields: ["name"],
                        displayField: "name",
                        exactMatch: false,
                        placeholder: "Search by name"
                    }
                ]
            });
            view.ui.add(searchWidget, "top-left");

            // Switches for Filters
            const switchContainer = document.createElement("div");
            switchContainer.style.position = "absolute";
            switchContainer.style.bottom = "60px";
            switchContainer.style.right = "25px";
            switchContainer.style.background = "rgba(255,255,255,0.7)";
            switchContainer.style.padding = "10px";
            switchContainer.style.zIndex = "1";

            const createSwitch = (labelText, onChange) => {
                const switchDiv = document.createElement("div");
                const switchInput = document.createElement("input");
                switchInput.type = "checkbox";
                switchInput.addEventListener("change", onChange);
                const switchLabel = document.createElement("label");
                switchLabel.style.marginLeft = "5px";
                switchLabel.textContent = labelText;
                switchDiv.appendChild(switchInput);
                switchDiv.appendChild(switchLabel);
                return switchDiv;
            };

            view.whenLayerView(SMES).then(layerView => {
                const ahdSwitch = createSwitch("AHD levelling only", event => {
                    layerView.filter = event.target.checked
                        ? new FeatureFilter({ where: "symbol = 'SC'" })
                        : null;
                });
                const defectiveSwitch = createSwitch("Hide defective marks", event => {
                    layerView.filter = event.target.checked
                        ? new FeatureFilter({ where: "symbol <> 'D'" })
                        : null;
                });
                switchContainer.appendChild(ahdSwitch);
                switchContainer.appendChild(defectiveSwitch);
                document.body.appendChild(switchContainer);
            });
        });
    </script>
</body>
</html>
